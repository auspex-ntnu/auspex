steps:
# Build the container image
- name: 'gcr.io/cloud-builders/docker'
  env:
    - DOCKER_BUILDKIT=1
  args: ['build', '-t', '${_IMAGE_NAME}', '-f', 'setup/Dockerfile', '.']
# Push the container image to Container Registry
- name: 'gcr.io/cloud-builders/docker'
  args: ['push', '${_IMAGE_NAME}']
# Run the setup as a one-off job
- name: 'eu.gcr.io/${PROJECT_ID}/auspex/setup'
  env:
    - COLLECTION_REPORTS=${_COLLECTION_REPORTS}
    - COLLECTION_SCANS=${_COLLECTION_SCANS}
    - BUCKET_SCANS=${_BUCKET_SCANS}
    - BUCKET_REPORTS=${_BUCKET_REPORTS}
    - GOOGLE_CLOUD_PROJECT=${PROJECT_ID}

timeout: 1200s
images:
- ${_IMAGE_NAME}

# https://cloud.google.com/build/docs/configuring-builds/substitute-variable-values#dynamic_substitutions
substitutions:
    _IMAGE_NAME: 'eu.gcr.io/${PROJECT_ID}/auspex/setup'
    _BUCKET_REPORTS: auspex-reports
    _COLLECTION_REPORTS: auspex-reports
    _COLLECTION_SCANS: auspex-scans
    _BUCKET_SCANS: auspex-scans
options:
    dynamic_substitutions: true
